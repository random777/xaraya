--
-- 04-xml
--
print("--- Group 4: XML syntax ---")
xmltest="Only well formed XML in templates";xmllist=''
commenttest="No use of ---> in templates"; commentlist=''
local got_one = false
local can_go  = true
if execute ~= nil then
    -- inside monotone, see if we can find xmllint
    if program_exists_in_path('xmllint') == false then
        can_go = false
        failed('4.*',xmltest,'No valid XML parser found on your system')
    else
        -- if we have an environment string called OS we have Windows
        local envstr
        envstr = os.getenv("OS")
        if envstr == nil then
            -- we are on *NIX and need bash   
            if program_exists_in_path('bash') == false then
                can_go = false
                failed('4.*','Could not find the bash shell on your *NIX system')
            end
        else
            -- We are on Windows ... and fake a successful result
            passed('4.11','XML is currently NOT TESTED on Windows machines')
            can_go = false
        end
    end
else
    -- outside monotone, TODO for another day :-)
end

if can_go then
    for index,file in pairs(commit_files) do
        if(string.find(file,'%.x[d|t]$')) then
            got_one = true
            -- xmlfile, syntax check it
            io.write('.')
            io.flush() -- otherwise it's buffered
            -- os.execute is protected, and the mtn execute doesnt allow to suppress output
            if execute~=nil then
                -- inside monotone
                if (execute('bash',qa_location..'pre-commit/lib/lintxml',file) ~=0) then
                    xmllist = xmllist .. '  syntax check failed on: '..file..'\n'
                end
            else
                if (os.execute('bash '..qa_location..'pre-commit/lib/lintxml '..file) ~=0) then
                    xmllist = xmllist .. '  syntax check failed on: '..file..'\n'
                end
            end
        end
    end
    if got_one then 
        io.write('\n') 
    end
    if xmllist ~='' then
        failed('4.11',xmltest,xmllist)         
    else 
        passed('4.11',xmltest) 
    end
end
