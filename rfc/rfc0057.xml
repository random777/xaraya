<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="rfc2629.xsl"?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd">
<!-- <?rfc private='my private memo'?>  Produce a private memo rather than a Xaraya-standard -->
<?rfc editing="yes"?>
<?rfc toc="yes"?>
<?rfc tocdepth="3"?>
<rfc number="0057" category="std">
  <front>
    <title>Directory Layout</title>
    <author initials="J.W." surname="Robeson" fullname="John William Robeson, Jr">
      <organization>Xaraya Development Group</organization>
      <address>
        <email>johnny@localmomentum.net</email>
      </address>
    </author>
    <author initials="M.R." surname="van der Boom" fullname="Marcel van der Boom">
      <organization>Xaraya Development Group</organization>
      <address>
        <email>marcel@hsdev.com</email>
      </address>
    </author>
    <date month="May" year="2008"/>
    <!-- The abstract summarizes in one or two paragraphs the content of the RFC -->
    <abstract>
      <t>The contents of this RFC describes the directory organization of a Xaraya install.</t>
    </abstract>
  </front>
  <!-- The middle section is used for the actual content of the RFC -->
  <middle>
    <section title="Introduction">
      <t>
        Having literally everything below the webroot is limiting deployment choices.
        Below are some thoughts on how we could organize the files and directories in 
        a way where things which do not need to be below the webroot, can be placed 
        outside of it. 
      </t>
      <t>
      Before we outline the directory layout, lets list some definitions and assumptions 
     so we can make informed decision on the directory layout.
      </t>
    </section>
    <section title="Rationale">
      <t>Reorganizing the directory layout is intrusive, very intrusive. Why is it 
          that we are even considering to do this? This section hopes to clarify some
          of the reasons.
      </t>
      <list style="hanging">
        <t hangText="Security:">
        This is a simple argument. Anything below the webroot is in theory accessible 
by the webserver. There are special actions needed to prevent certain access. 
Putting in a special config directive in the webserver configuration, putting 
empty index.html files in folders, checking wether files are accessed directly, 
where they should not have been etc. etc.

By putting files outside the webroot of which we know upfront the webserver 
doesnt need direct/URL based access to (a php program running on that server may 
have/need access to them however) we make that access impossible, so the amount
of measures needed is less, and if files contain code which would be risky to
put in an URL accessible file it is protected from such access by default.
In short, this makes the people who admin a server sleep better.
        </t>
        <t hangText="Deployment:">
          Xaraya is often used as a hub to manage more than one, of even a lot of sites.
Currently, if not using special deployment tricks like symlinks or bind mounting,
the code has to be put into each Xaraya install. Typically, the code used in
all those installs is for the most part identical except for the app/site specific
parts the site has to have.
<vspace blankLines="1" />
Allowing to put common parts in a shared location can save a considerable amount
of diskspace (esp. in php, since all php files are usually bincached too) and
provide extra flexibility to run different core versions.
Specifically for 'xaraya hosting' this is interesting since the shared install
can be pre-made for the clients, where they only have to worry about their specifics.
        </t>
        <t hangText="Integration:">
        Being a framework, xaraya often integrates other libraries and is integrated 
often in larger scope setups _as_ a library. Other packages all have their own
rules and peculiarities on how they deal with files and where to put them. 
Taking a library approach provides more options and can make integration
activities a lot easier when there are configuration settings provided on how
to deal with file locations, include paths etc. 
        </t>
      </list>
    </section>
    <section title="Defintions">
      <list style="hanging">
        <t hangText="install:">
          An 'install' is one copy of the framework code, identified by a
          version (number, hash or otherwise) at a certain location
        </t>
        <t hangText="instance:">
          An 'instance' is the result of using one install to create one or more sites.
        </t>
        <t hangText="database:">
          A 'database' is a storage container which holds the data for exactly one instance. 
        </t>
        <t hangText="site:">
          A 'site' is a collection of data within one instance belonging to one website.
        </t>
      </list>
    </section>
    <section title="Assumptions">
      <list style="numbers">
        <t>Each 'install' can have one or more 'instances'.</t>
        <t>Each 'instance' has a default 'site', in absence of extra information, data belongs to the default 'site'</t>
        <t>Each 'instance' can have many 'sites', but always has at least one.(master-site?)</t>
        <t>Each 'site' belongs to exactly one 'instance'.</t>
        <t>One server can support many 'installs', possibly differing in version.</t>
      </list>        
    </section>
    <section title="Consequences">
      <list style="symbols">
          <t>the changed directory layout satisfying the above assumptions (that was the aim)</t>
          <t>introduction of a 'site' concept/object</t>
          <t>introduction of a 'instance' concept/object</t>
        </list>
    </section>
    <section title="Directory Layout">
      <t>The above suggests:</t>
        <list style="symbols">
          <t>2 main locations, one for the install and one for (each) instance</t>
          <t>we need at least one webroot per instance, it makes sense to leave it at
              that too and let sites within one instance share their webroot. This
              effectively links one webroot to one database, which is easy to remember.
          </t>
          <t>the default site is implicit and sites can be managed from within the
              instance so we dont need to explicitly create directories for it. This makes
              a multi site instance look the same as a single site instance from a
              files/dirs perspective.
          </t>
          <t>its obvious that the 'install' area needs a place to hold code and libraries
              This area will be the main include area for the program. At the same
              time we want to have the option to transparently include and use code
              specific to one instance, so we mirror that lib directory in the instance
              location.
          </t>
          <t>to distinguish libraries from us and third parties below lib there is the
              'namespace' xaraya which can hold our libraries. Third party libraries also
              get their own namespace (directory)
          </t>
          <t>to bootstrap an instance and tie it to its database, a file containing the
              configuration for that is needed (current config.system.php I guess) To hold
              this and possible other configurations => conf (xml/txt/php tbd) The global
              environment also has a conf location to provide sensible defaults
          </t>
          <t>each instance may/will generate variable data related only to its specific
              configuration  /var. This has no global equivalent in the install.
          </t>
          <t>locale information is typically global (note: this is not the same as
              translations!) so we designate a global location for that => locales We can
              look up the most convenient way to store locale information, i.e. one file
              per locale or a directory with multiple, doesnt matter much.
          </t>
          <t>modules will definitely have to go outside the webroot, as we want to have
              them both globally installed (for all instances) and at the specific
              in stance levels.
          </t>
          <t>modules will inherit and be able to override most functions/templates from
             the global install
          </t>
        </list>
    </section>
    <section title="Global Environment">
      <t>The global install environment should be viewed upon as something like 'xar.exe'
          it's an immutable collection of things which are used to generate new instances
          (i.e. a new 'default site'), and provide defaults for the sites using this particular install.
          "Running xar.exe" could be done through a web interface or a cmdline, whatever
          we have time to create. (ideally both).
      </t>
      <t>Translation from our current situation, it could be viewed upon as a 'consolidated installer'
          or 'server admin part'; one level higher than what our current UI exposes. 
          The 'global environment' needs to be configured in the webserver specifically:
      </t>
      <artwork><![CDATA[
     /path/to/install
         /bin                            [cmd line interface for the managing of instances]
             ...                         
         /conf
             xaraya.conf                 [global configuration defaults]
             /skeleton                   [entry point for instance skeletons, used during creation of new instances]
                 ?
         /html                           [web interface of the install]
             .htaccess
             default.php                 [named it default.php to indicate its different than index.php in the instance]
             /themes                     [themes globally available for instances]
                 /default
                     package.xml         [theme meta information]
                         /style          [styling files]
                         /scripts        [client scripts]
                         /images         [icons and other global images]
                         /xsl            [BL tags]
                         ...             [flash, or anything else]
                     /pages              [page structure templates]
                         default.xt      (why do we use .xt vs .xd again?)
                 ...    
         /lib
             /xaraya                     [ xaraya library, 'core']
                 ...
             /zend                       [ 
                 ...                       third party libraries like Zend, propel,
             ...                           binarycloud, PEAR, etc.                             
             /greatlib                   ]    
         /modules                        [modules globally available for instances]
             /globalmodname
                 package.xml             [module meta information]
                 /api                    [offering]
                     ?
                 /assets
                     images/
                     scripts/
                     styles/
                     ...                 [flash, or whatever else]
                 /gui                    [presentation]
                     ?
                 /lib                    [implementation]
                     ...
                 /data
                     schema.xml          [storage container definitions]
                     data.xml            [default data for initial populate]
                     routes.xml          [url mapping/routing]
                     security.xml        [privileges]
                 /templates
                     ?
                 
             ...
         /locales
             /en_US
                 locale.xml              [ locale specification ]
             /nl_NL
                 locale.xml
      ]]></artwork>
    </section>
    <section title="Instance Environment">
      <t>The instance environment is created through the 'xar instance manager'. The effect of
          using the instance manager is to 'generate' the necessary structure for starting a 
          (collection of) websites. The necessary directories are created, the proper config is
          put into place etc.
      </t>
      <figure>
        <preamble>A minimal instance might look something like this:</preamble>
        <artwork><![CDATA[
            /path/to/instance
        /conf
            default.conf                
        /html
            .htaccess
            index.php
        /var
            /default
                /cache
                    /output
                      /images
                      /scripts
                      /styles
                      /templates
                /logs
        ]]></artwork>
      </figure>
      <figure>
        <preamble>An instance structure showing all possible options might look something like this:</preamble>
        <artwork><![CDATA[
        /path/to/instance
        /conf
            default.conf                [default site config, plus defaults for all sites]
            siteX.conf                  [siteX specific config]
            siteY.conf
        /html                           [webroot for all sites in the instance]
            .htaccess                   [webserver specific config file]
            index.php                   [entry point]
          /themes
            /themename
                package.xml         [theme meta information]
                  /style              [styling files]
                  /scripts            [client scripts]
                  /images
                /pages              [page structure templates]
                    default.xt      (why do we use .xt vs .xd again?)
        /lib
            /specialstuff
            ...   
        /modules
            /localmodname
                package.xml             [module meta information]
                /api                    [offering]
                /conf                   [additional configuration]
                /gui                    [presentation]
                /lib                    [implementation]
                /data
                    schema.xml          [storage container definitions]
                    data.xml            [default data for initial populate]
                    routes.xml          [url mapping/routing]
                    security.xml        [privileges]
                /templates
            ...
        /var
            /default
                /cache
                    /output
                    /templates
                /logs
            /siteX
                /cache
                    /output
                    /templates
                /logs
            /siteY
                /cache
                    /output
                    /templates
                /logs
            /modules
                /modname                [module modname's data area]
                    ...
      ]]></artwork>
      </figure>
    </section>
    <section title="Analysis">
      <t>As there is a global and instance environment now, we basically also create
          a new override point, which we may or may not want to exploit. An example is
          to override a module template in the instance area. The 'meaning' of this 
          override would be: "i want this to apply for this instance, regardless of
          theme, unless the theme overrides it specifically."
      </t>
    </section>
    <section title="Unresolved Issues">
      <artwork><![CDATA[

    Q: where do client libraries like js frameworks go?
    A: either they go directly below the 'scripts' directory in the theme or are
    made available in the lib section globally or in an instance. 

    Q: why are locales needed on fs? 
    A: 

    Q: how much webserver specific configuration like aliases etc. would we 
    need for this
    A: - the install needs to have a configuration in the webserver probably, the
    instances are generated from that install, so we can make sure things are properly
    generated for each instance without having a need for a specific configuration
    in the webserver.

   Q: should we create a system "Application" theme that include common head content 
      like default styles, js library inclusion, required content types like json?
   A:
]]></artwork>
    </section>
  </middle>
  <back>
  </back>
</rfc>
